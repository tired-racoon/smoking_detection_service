# Сервис для мониторинга записей с городских видеокамер и детектирования курения

## Запуск сервера

После скачивания зависимостей из `requirements` вы можете запустить сервер с помощью `uvicorn`.

```bash
uvicorn main:app --reload
```

Сервер запустится и по умолчанию будет доступен по адресу `http://127.0.0.1:8000`. Флаг `--reload` позволяет серверу автоматически перезапускаться после изменений в коде.

## Как пользоваться

Документация API генерируется автоматически и доступна по адресу `http://127.0.0.1:8000/docs`.

### Основной рабочий процесс

1.  **Создайте стрим:**
    Отправьте `POST` запрос на эндпоинт `/stream/request` для создания новой сессии стриминга.
    
    Вы можете использовать такой инструмент, как `curl`:
    ```bash
    curl -X POST http://127.0.0.1:8000/stream/request
    ```
    
    Сервер ответит уникальным `stream_id` (токеном):
    ```json
    {
      "stream_token": "ваш-уникальный-идентификатор-стрима",
      "stream_id": "ваш-уникальный-идентификатор-стрима",
      "video_uuid": "ваш-уникальный-идентификатор-стрима",
      "video_id": "ваш-уникальный-идентификатор-стрима",
      "websocket_url": "/ws/stream/ваш-уникальный-идентификатор-стрима",
      "status": "active"
    }
    ```

2.  **Начните трансляцию:**
    Используйте клиент для подключения к WebSocket URL (`ws://127.0.0.1:8000/ws/stream/{ваш-уникальный-идентификатор-стрима}`) и начните отправлять видеокадры в виде строк `data:image/jpeg;base64,...`. Примеры на Python и JavaScript можно найти в документации API (`/docs`).

3.  **Просмотр стрима:**
    У вас есть два варианта просмотра стрима:

    *   **MJPEG поток:** Откройте следующий URL в своем браузере или видеоплеере, таком как VLC:
        ```
        http://127.0.0.1:8000/stream/video/{ваш-уникальный-идентификатор-стрима}
        ```
        Это подходит для прямого воспроизведения видео.

    *   **Веб-просмотрщик (для обработанных данных):** Откройте встроенную страницу просмотрщика:
        ```
        http://127.0.0.1:8000/viewer
        ```
        Введите ваш `stream_id` в поле ввода и нажмите "Watch Stream". Эта страница подключается к WebSocket и отображает любые JSON-данные, транслируемые в стрим.

### Остановка стрима

Стрим автоматически остановится, и все его ресурсы будут освобождены, когда последний подключенный WebSocket клиент (как транслятор, так и просмотрщик) отключится.