<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Тепловая карта Сириуса</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([43.4080, 39.9490], 14);

        map.createPane('backgroundPane');
        map.getPane('backgroundPane').style.zIndex = 350;

        map.createPane('heatmapPane');
        map.getPane('heatmapPane').style.zIndex = 450;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const siriusBounds = [
            [42.3950, 38.9350],
            [44.4200, 40.9650]
        ];

        const blueOverlay = L.rectangle(siriusBounds, {
            color: 'blue',
            fillColor: 'blue',
            fillOpacity: 0.5,
            weight: 0,
            pane: 'backgroundPane'
        }).addTo(map);

        let currentHeatLayer = null;

        function loadHeatmapData() {
            fetch('/api/heatmap-data')
                .then(response => response.json())
                .then(data => {
                    if (currentHeatLayer) {
                        map.removeLayer(currentHeatLayer);
                    }

                    const heatPoints = data.map(point => [point.lat, point.lng, point.intensity || 1.0]);

                    if (heatPoints.length > 0) {
                        currentHeatLayer = L.heatLayer(heatPoints, {
                            radius: 25,
                            blur: 15,
                            maxZoom: 17,
                            gradient: { 0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1.0: 'red' }
                        }).addTo(map);

                        if (currentHeatLayer._canvas) {
                            map.getPane('heatmapPane').appendChild(currentHeatLayer._canvas);
                            currentHeatLayer._canvas.style.zIndex = 450;
                        }
                    }
                })
                .catch(error => console.error('Ошибка:', error));
        }

        loadHeatmapData();

        setInterval(loadHeatmapData, 2000);
    </script>
</body>
</html>